let currentBaseLayer=JSON.parse(localStorage.getItem("currentBaseLayer"))??"Standard",historyMode=!!JSON.parse(localStorage.getItem("historyMode"));const styles=[{name:"Standard",url:"mapbox://styles/mapbox/standard"},{name:"Dark",url:"mapbox://styles/mapbox/navigation-night-v1"},{name:"History",url:"https://www.openhistoricalmap.org/map-styles/main/main.json"}];let userGeo,searchTerm,selectedPoi,selectedSearch,selectedHistoricalEvent,countryPopup,eventPopup,errorMapTimer,wikipediaTimer,categoryList=[],mostRecentLocation={latitude:null,longitude:null,context:{iso_a2:null,region:null,place:null,neighborhood:null,district:null,name:null}},searchResults=[],currentPois=[],historicalEvents=[],previousPois=[],currentPoiCategory="default",countryList=[],hoveredCountryId=null,chosenCountryISO=null,pausePoiSearch=!1,historyMarkerGroup=[],currentDate=null,currentMarker=null,disableAllButtons=!1,categoryPanelButtons=["#hotel-button","#bank-button","#museum-button","#shopping-button","#food_and_drink-button","#coffee-button","#park-button"],tokenCache={token:null,expiresAt:null};const tokenIsValid=()=>tokenCache.token&&Date.now()<tokenCache.expiresAt,getToken=async()=>{if(tokenCache.token&&Date.now()<tokenCache.expiresAt)return tokenCache.token;const t=await $.ajax({url:"/api/mapboxgljs/token",method:"GET",dataType:"json"});return mapboxgl.accessToken=t.data.token,tokenCache.token=t.data.token,tokenCache.expiresAt=Date.now()+6e4,t.data.token},showBigError=(t,e)=>{$("#error-screen").attr("aria-disabled","false"),$("#big-error-title").text(t),$("#big-error-subtitle").text(e)},initialiseMap=()=>new Promise((async(t,e)=>{try{await $.ajax({url:"/api/mapboxgljs/map",dataType:"json",method:"GET"});let e,a=styles[2].url;try{e=await getToken()}catch(t){throw t}historyMode||(a=styles.find((t=>currentBaseLayer===t.name)).url),map=new mapboxgl.Map({style:a,projection:"globe",container:"map",zoom:1,padding:{left:80,right:0,top:0,bottom:0},minZoom:.7,maxZoom:17,center:[30,15]}),map.on("load",(async()=>{if($("#search").val(""),$("#preloader").length&&$("#preloader").fadeOut("slow",(function(){$(this).remove()})),historyMode)return applyHistoryHtml(!0),applyHistoryStyles(),applyCountryLayers(),map.filterByDate("2020-01-01"),t(map);applyHistoryHtml(!1),"Dark"===currentBaseLayer?nightNavStyles(map):(map.setConfigProperty("basemap","showPointOfInterestLabels",!1),map.setFog({color:"rgb(11, 11, 25)","high-color":"rgb(36, 92, 223)","horizon-blend":.02,"space-color":"rgb(11, 11, 25)","star-intensity":.6})),await applyCountryLayers(),await retrieveAndApplyIcons(e),t(map)}))}catch(t){const o=t.responseJSON.details;a="Can't load map",n=o,$("#error-screen").attr("aria-disabled","false"),$("#big-error-title").text(a),$("#big-error-subtitle").text(n),e("Token could not be retrieved")}var a,n})),popupOffsets={top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-30],"bottom-left":[0,-30],"bottom-right":[0,-30],left:[0,0],right:[0,0]};let animating=!1;const createModernCountryPopup=async t=>new Promise((e=>{const{restCountries:a}=t,{flags:n,name:o,population:i,capital:r,area:l,coatOfArms:s,translations:d,currencies:c,region:m,subregion:u}=a;countryPopup=new mapboxgl.Popup({offset:popupOffsets,anchor:"center",closeButton:!1,closeOnClick:!1,className:"country_popup  lg:!max-w-3xl md:!max-w-2xl sm:!max-w-lg xs:!max-w-[23rem] !max-w-sm !w-full"});const p=Object.entries(d).map((([t,e])=>("cym"===t&&(t="eng"),{...e,code:t=t.toUpperCase()}))).sort(((t,e)=>"ENG"===t.code?-1:"ENG"===e.code?1:0)),g=Object.entries(c).map((([t,e])=>({...e,code:t})))[0];countryPopup.setHTML(`\n          <div class='flex flex-col gap-2'>\n           <div class='grid grid-cols-[repeat(auto-fit,_minmax(250px,_1fr))] md:mt-3 mt-6 transition-all duration-300 gap-2 items-center'>\n              <div id='country-image-button' title='Change country photo' aria-label='Change country photo' role='button'  aria-hidden='true' class='flex border-r-2  border-b-2 p-2 aspect-[2/1] h-full overflow-hidden w-full self-start relative rounded-bl-none rounded-br-md rounded-tr-none border-white-50 group/button'>\n                <div class='bg-black/70 flex items-center justify-center group-hover/button:scale-110 scale-100 z-50 group-hover/button:bg-black/100  border-2 border-white-50 absolute top-2 right-2 w-7 h-7 transition-all duration-100 ease-in delay-75 rounded-md'>\n                  <i class="fa-solid fa-right-left text-lg transition-all ease-in group-hover/button:text-white-50 text-white-300"></i>\n                </div>\n                  <img id='country-flag' src="${n.svg??n.png}" class=' w-full translate-x-4 object-contain delay-0 opacity-0 group-aria-hidden/button:opacity-100 relative group-aria-hidden/button:delay-1000 group-aria-hidden/button:translate-x-0 transition-all rounded-md ease-in-out' alt="${n.alt}" >\n                  <img id='country-coat' src="${s.svg??s.png}" class='bg-[conic-gradient(from_100deg_at_10%_65%,#a100ff_0%_8%,_#4d9cff_26%,#5c2970_26%_32%,#0000_30%_100%),_linear-gradient(to_left,_#264b8d,_rgb(168_85_247_/_0))] w-full delay-1000 border-4 border-white-300 opacity-100 object-contain group-aria-hidden/button:opacity-0 invisible rounded-md absolute group-aria-hidden/button:delay-0 group-aria-hidden/button:-translate-x-4 translate-x-0 transition-all ease-in-out' >\n              </div>\n\n              <div class='flex flex-col relative gap-4 h-fit'>\n              \n                <div id='country-name-button' role='button' title='Toggle name type' aria-label='Toggle name type'  aria-hidden='true' class='grid grid-cols-[max-content_auto] relative items-center p-2 gap-3 group/button'>\n                  \n                  <div class='group/toggle'>\n                    <i id='name-toggle' class="fa-solid fa-toggle-off cursor-pointer group-aria-hidden/button:text-white-600 group-hover/toggle:opacity-100 group-hover/button:opacity-100 opacity-70 transition-all ease-in duration-100 text-sky-500 text-2xl"></i>\n                  </div>\n                  <div id='name-container' class='flex items-center md:justify-normal justify-center'>\n                    <div  id='name-common' class="sm:text-3xl  xs:text-2xl text-xl text-center translate-x-4 delay-0 opacity-0 group-aria-hidden/button:opacity-100 relative font-title  group-aria-hidden/button:delay-1000 group-aria-hidden/button:translate-x-0 transition-all text-white-300  ease-in-out font-extrabold"\n                    >\n                      <span id='name-common-inner' aria-hidden='false' class='transition-all  ease-in-out duration-150 opacity-100 aria-hidden:opacity-0  [word-break:break-word]'>${o.common}</span>\n                    </div>\n                    <div  id='name-official' class="sm:text-3xl xs:text-2xl text-xl  py-1 max-h-[120px] overflow-y-auto opacity-100 text-center  translate-x-0 invisible absolute group-aria-hidden/button:opacity-0 group-aria-hidden/button:delay-0 font-title  delay-1000 group-aria-hidden/button:-translate-x-4 text-white-300 transition-all  ease-in-out font-extrabold"\n                    >\n                      <span id='name-official-inner' aria-hidden='false' class='transition-all  ease-in-out duration-150 opacity-100 aria-hidden:opacity-0  [word-break:break-word]'>${o.official}</span>\n                    </div>\n                  </div>\n                </div>\n              </div>\n              <div class='absolute z-50 right-0 flex items-center justify-center gap-1 top-2 min-w-6'>\n                <div role='button' title='Change name translation' aria-label='Change name translation' id='left-arrow' class='group flex items-center justify-end w-8'>\n                  <i class="fa-solid fa-caret-left  text-xl scale-100 opacity-60 group-hover:opacity-100 group-hover:scale-110 group-active:scale-100 transition-all ease-in duration-100"></i>\n                </div>\n                <div class='min-w-11 text-center'>\n                  <span aria-hidden='false' class='text-lg transition-all  ease-in-out duration-150 opacity-100 aria-hidden:opacity-0 font-title font-bold' id='translation-choice'>\n                    ${p[0].code}\n                  </span>\n                </div>\n                <div role='button' title='Change name translation' aria-label='Change name translation' id='right-arrow' class='group flex items-center justify-start w-8'>\n                  <i class="fa-solid fa-caret-right text-xl scale-100 opacity-60 group-hover:opacity-100 group-hover:scale-110 group-active:scale-100 transition-all ease-in duration-100"></i>\n                </div>\n              </div>\n            </div>\n            <div class='my-2'>\n              <table class='border-0 w-full overflow-x-auto table-fixed'>\n                <thead>\n                  <tr class='*:font-title *:font-bold *:text-sm xs:*:text-lg sm:*:text-xl'>\n                    <th class='odd:bg-purple-800/60 even:bg-black/60 rounded-l-md'>Region</th>\n                    <th class='odd:bg-purple-800/60 even:bg-black/60'>Subregion</th>\n                    <th class='odd:bg-purple-800/60 even:bg-black/60 rounded-r-md'>Capital</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  <tr class='*:font-sans *:font-medium text-xs xs:*:text-sm sm:*:text-lg *:text-center'>\n                    <td>${m}</td>\n                    <td>${u}</td>\n                    <td>${r}</td>\n                  </tr>\n                </tbody>\n              </table>\n            </div>\n            <div class='grid grid-cols-[repeat(auto-fill,_minmax(250px,_1fr))] gap-4 p-2'>\n              <div class='flex items-baseline gap-2'>\n                <div class='rounded-md flex items-center justify-center w-7 h-7  border border-white-300 bg-gradient-to-r from-blue-300 via-purple-500 gap-2 to-pink-500'>\n                  <i class="fa-solid fa-users-between-lines text-white-50 text-lg"></i>\n                </div>\n                <span class='sm:text-xl text-lg font-title'>${i.toLocaleString()} <span class='text-lg font-title'>people</span></span>\n              </div>\n              <div class='flex items-baseline gap-2'>\n                <div class='flex items-center justify-center w-7 h-7 rounded-md border border-white-300 bg-gradient-to-r from-blue-300 via-purple-500 gap-2 to-pink-500'>\n                  <i class="fa-solid fa-coins text-white-50 text-lg"></i>                \n                </div>\n                <div class='*:mr-1'>\n                  <span class='sm:text-xl text-lg font-title'>${g.symbol}</span> \n                  <span class='sm:text-xl text-lg font-extralight relative bottom-0.5'>|</span>\n                  <span class='sm:text-xl text-lg font-title'>${g.code}</span> \n                  <span class='sm:text-xl text-lg font-extralight relative bottom-0.5'>|</span>\n                  <span class='sm:text-xl text-lg font-title'>${g.name}</span>\n                </div> \n              </div>\n              <div class='flex items-baseline gap-2'>\n                <div class='flex items-center justify-center w-7 h-7 rounded-md border border-white-300 bg-gradient-to-r from-blue-300 via-purple-500 gap-2 to-pink-500'>\n                  <i class="fa-solid fa-expand text-white-50 text-lg"></i>\n                </div>\n                <span class='sm:text-xl text-lg font-title'>${l.toLocaleString()} </span>\n                <span class='text-lg  font-title'>kilometers</span>\n              </div>\n            </div>\n          </div>\n`),map.once("moveend",(()=>{const{lng:t,lat:a}=map.getCenter();countryPopup.setLngLat([t,a]).addTo(map),disableMapInteraction(!1),e(),setTimeout((()=>{const t=$("#name-common")[0],e=$("#name-official")[0];if(t&&e){const a=Math.max(t.scrollHeight,e.scrollHeight);$("#name-container").css("height",`${a}px`)}}),100),$("#right-arrow").on("click",(t=>{t.stopPropagation(),animating||(animating=!0,$("#name-common-inner").attr("aria-hidden","true"),$("#name-official-inner").attr("aria-hidden","true"),$("#translation-choice").attr("aria-hidden","true"),setTimeout((()=>{const t=p.findIndex((t=>t.code===$("#translation-choice").text().trim())),e=p[t===p.length-1?0:t+1];$("#translation-choice").text(e.code),$("#name-common-inner").text(e.common),$("#name-official-inner").text(e.official),$("#name-common-inner").attr("aria-hidden","false"),$("#name-official-inner").attr("aria-hidden","false"),$("#translation-choice").attr("aria-hidden","false"),animating=!1}),150))})),$("#left-arrow").on("click",(t=>{t.stopPropagation(),animating||(animating=!0,$("#name-common-inner").attr("aria-hidden","true"),$("#name-official-inner").attr("aria-hidden","true"),$("#translation-choice").attr("aria-hidden","true"),setTimeout((()=>{const t=p.findIndex((t=>t.code===$("#translation-choice").text().trim())),e=p[0===t?p.length-1:t-1];$("#translation-choice").text(e.code),$("#name-common-inner").text(e.common),$("#name-official-inner").text(e.official),$("#name-common-inner").attr("aria-hidden","false"),$("#name-official-inner").attr("aria-hidden","false"),$("#translation-choice").attr("aria-hidden","false"),animating=!1}),150))})),$("#country-image-button").on("click",(function(){if(animating)return;animating=!0;"false"===$("#country-image-button").attr("aria-hidden")?($("#country-image-button").attr("aria-hidden","true"),$("#country-coat").removeClass("animate-start_absolute"),$("#country-coat").addClass("animate-end_absolute"),$("#country-flag").removeClass("invisible"),setTimeout((()=>{$("#country-flag").removeClass("animate-end_absolute"),$("#country-flag").addClass("animate-start_absolute"),$("#country-coat").addClass("invisible"),animating=!1}),500)):($("#country-image-button").attr("aria-hidden","false"),$("#country-flag").removeClass("animate-start_absolute"),$("#country-flag").addClass("animate-end_absolute"),$("#country-coat").removeClass("invisible"),setTimeout((()=>{$("#country-coat").removeClass("animate-end_absolute"),$("#country-coat").addClass("animate-start_absolute"),$("#country-flag").addClass("invisible"),animating=!1}),500))})),$("#country-name-button").on("click",(function(){if(animating)return;animating=!0;"false"===$("#country-name-button").attr("aria-hidden")?($("#country-name-button").attr("aria-hidden","true"),$("#name-official").removeClass("animate-start_absolute"),$("#name-official").addClass("animate-end_absolute"),$("#name-toggle").removeClass("fa-toggle-on"),$("#name-toggle").addClass("fa-toggle-off"),$("#name-common").removeClass("invisible"),setTimeout((()=>{$("#name-common").removeClass("animate-end_absolute"),$("#name-common").addClass("animate-start_absolute"),$("#name-official").addClass("invisible"),animating=!1}),500)):($("#country-name-button").attr("aria-hidden","false"),$("#name-common").removeClass("animate-start_absolute"),$("#name-common").addClass("animate-end_absolute"),$("#name-toggle").removeClass("fa-toggle-off"),$("#name-toggle").addClass("fa-toggle-on"),$("#name-official").removeClass("invisible"),setTimeout((()=>{$("#name-official").removeClass("animate-end_absolute"),$("#name-official").addClass("animate-start_absolute"),$("#name-common").addClass("invisible"),animating=!1}),500))}))}))}));async function createHistoryCountryPopup(t){return new Promise((e=>{const a=new Intl.Segmenter("en",{granularity:"sentence"}),n=Array.from(a.segment(t.extract),(t=>t.segment)).reduce(((t,e,a)=>(a%5==0&&t.push([]),t[t.length-1].push(e),t)),[]).map((t=>t.join(" ")));countryPopup=new mapboxgl.Popup({offset:popupOffsets,anchor:"center",closeButton:!1,closeOnClick:!1,className:"country_popup lg:!max-w-3xl md:!max-w-2xl sm:!max-w-lg xs:!max-w-[23rem] !max-w-sm !w-full"});const o=t.image??"libs/css/assets/history-fallback.jpg";countryPopup.setHTML(`\n    <div class='flex flex-col overflow-hidden overflow-y-auto max-h-[400px]'>\n      <div class='flex relative after:absolute after:content-[""] after:-bottom-3 md:after:-bottom-4 after:left-[1%] after:w-[98%] after:bg-white-300 items-center after:h-[1px] gap-2 md:gap-1 mt-4 md:mb-4 md:mt-4'>\n        <div class='p-1 h-9 flex items-center justify-center rounded-md bg-[#663399] shadow-[0px_0px_3px_white_inset,_0px_0px_10px_#663399]'>\n          <i class="fa-solid fa-timeline text-xl md:text-2xl text-white-300"></i>\n        </div>\n        <div class='font-title text-2xl md:text-3xl p-1 text-white-50'>${t.title}</div>\n      </div>\n      <div class='grid grid-cols-[repeat(auto-fit,_minmax(250px,_1fr))] md:px-0 px-1 gap-0 md:gap-4 md:mt-3 mt-6 transition-all duration-300 items-center'>\n        <div class='self-start rounded-tr-md rounded-tl-md border-t-2 border-l-2 md:border-t-0 md:border-l-0  border-2 md:rounded-bl-none md:rounded-tl-none  rounded-br-md md:rounded-tr-none border-white-300 p-2 overflow-hidden w-full relative'>\n          <img class='contain rounded-md' src='${o}' />\n        </div>\n        <div class='flex flex-col gap-4 p-2 mt-4 md:mt-0 rounded-md'>\n          ${n.map((t=>`<div class='font-abel text-lg text-white-300'>${t}</div>`)).join("")}\n        </div>\n      </div>\n    </div>\n    `),map.once("moveend",(()=>{const{lng:t,lat:a}=map.getCenter();countryPopup.setLngLat([t,a]).addTo(map),disableMapInteraction(!1),e()}))}))}const mapPromise=initialiseMap();mapPromise.then((t=>{t.scrollZoom.setWheelZoomRate(.005),t.scrollZoom.setZoomRate(.005)}));